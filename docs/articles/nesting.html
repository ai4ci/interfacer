<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Nested dataframes and `purrr` style list columns • interfacer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Nested dataframes and `purrr` style list columns">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">interfacer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/interfacer.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/consistency.html">Parameter consistency checking with interfacer</a></li>
    <li><a class="dropdown-item" href="../articles/devtools.html">Tools to work with `interfacer`</a></li>
    <li><a class="dropdown-item" href="../articles/dispatch.html">Multiple dispatch based on dataframes</a></li>
    <li><a class="dropdown-item" href="../articles/nesting.html">Nested dataframes and `purrr` style list columns</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bristol-vaccine-centre/interfacer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Nested dataframes and `purrr` style list columns</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bristol-vaccine-centre/interfacer/blob/HEAD/vignettes/nesting.Rmd" class="external-link"><code>vignettes/nesting.Rmd</code></a></small>
      <div class="d-none name"><code>nesting.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bristol-vaccine-centre.github.io/interfacer/">interfacer</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="nesting-list-columns">Nesting &amp; list columns<a class="anchor" aria-label="anchor" href="#nesting-list-columns"></a>
</h2>
<p><code>interfacer</code> is designed to work with list columns, as
generated by <code>purrr</code>. <code>purrr</code> style list columns
may contain any arbitrary data type within a list. Consider the
following complex dataframe for example, which includes a single regular
factor column, a nested dataframe as a list column, a nested S3
<code>lm</code> object as a list column and a nested matrix as a list
column:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tmp</span> <span class="op">=</span> <span class="va">iris</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>by_species <span class="op">=</span> <span class="op">-</span><span class="va">Species</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">by_species</span>, <span class="op">~</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">~</span> <span class="va">Sepal.Width</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    quantiles <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">by_species</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">quantile</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 3</span></span>
<span><span class="co">#&gt; Columns: 4</span></span>
<span><span class="co">#&gt; $ Species    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> setosa, versicolor, virginica</span></span>
<span><span class="co">#&gt; $ by_species <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> [&lt;tbl_df[50 x 4]&gt;], [&lt;tbl_df[50 x 4]&gt;], [&lt;tbl_df[50 x 4]&gt;]</span></span>
<span><span class="co">#&gt; $ model      <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> [2.6390012, 0.6904897, 0.04428474, 0.18952960, -0.14856834,…</span></span>
<span><span class="co">#&gt; $ quantiles  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> &lt;&lt;matrix[5 x 4]&gt;&gt;, &lt;&lt;matrix[5 x 4]&gt;&gt;, &lt;&lt;matrix[5 x 4]&gt;&gt;</span></span></code></pre></div>
<p><code>interfacer</code> can be used to both represent and validate
this data structure. Here the initial specifications were generated
using <code>iclip(tmp)</code> and hand modified:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Pasted from `iclip(tmp)` with minor modification:</span></span>
<span><span class="va">i_tmp</span> <span class="op">=</span> <span class="fu">interfacer</span><span class="fu">::</span><span class="fu"><a href="../reference/iface.html">iface</a></span><span class="op">(</span></span>
<span>    Species <span class="op">=</span> <span class="fu">enum</span><span class="op">(</span><span class="va">`setosa`</span>,<span class="va">`versicolor`</span>,<span class="va">`virginica`</span><span class="op">)</span> <span class="op">~</span> <span class="st">"the Species column"</span>,</span>
<span>    by_species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">i_by_species</span><span class="op">)</span> <span class="op">~</span> <span class="st">"the by_species column"</span>,</span>
<span>    model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">of_type</span><span class="op">(</span><span class="va">lm</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="st">"the model column"</span>,</span>
<span>    quantiles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">matrix</span><span class="op">)</span> <span class="op">~</span> <span class="st">"the quantiles column"</span>,</span>
<span>    .groups <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">i_by_species</span> <span class="op">=</span> <span class="fu">interfacer</span><span class="fu">::</span><span class="fu"><a href="../reference/iface.html">iface</a></span><span class="op">(</span></span>
<span>    Sepal.Length <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the Sepal.Length column"</span>,</span>
<span>    Sepal.Width <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the Sepal.Width column"</span>,</span>
<span>    Petal.Length <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the Petal.Length column"</span>,</span>
<span>    Petal.Width <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the Petal.Width column"</span>,</span>
<span>    .groups <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can then test that the input matches this specification:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/iconvert.html">iconvert</a></span><span class="op">(</span><span class="va">i_tmp</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 3</span></span>
<span><span class="co">#&gt; Columns: 4</span></span>
<span><span class="co">#&gt; $ Species    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> setosa, versicolor, virginica</span></span>
<span><span class="co">#&gt; $ by_species <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> [&lt;tbl_df[50 x 4]&gt;], [&lt;tbl_df[50 x 4]&gt;], [&lt;tbl_df[50 x 4]&gt;]</span></span>
<span><span class="co">#&gt; $ model      <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> [2.6390012, 0.6904897, 0.04428474, 0.18952960, -0.14856834,…</span></span>
<span><span class="co">#&gt; $ quantiles  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> &lt;&lt;matrix[5 x 4]&gt;&gt;, &lt;&lt;matrix[5 x 4]&gt;&gt;, &lt;&lt;matrix[5 x 4]&gt;&gt;</span></span></code></pre></div>
<p>Such specifications could be used for validation, or controlling
function dispatch. However it must be recognised that validation of
nested dataframes is potentially computationally expensive as each
individual nested dataframe must be completely validated. This could
create a high overhead in situations where there are a large number of
small nested dataframes.</p>
<p>Another example of a nested list column using the diamonds dataframe
demonstrates this overhead, where 276 nested dataframes need to be
validated individually. This takes a few seconds on my machine.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">i_diamonds_cat</span> <span class="op">=</span> <span class="fu">interfacer</span><span class="fu">::</span><span class="fu"><a href="../reference/iface.html">iface</a></span><span class="op">(</span></span>
<span>  cut <span class="op">=</span> <span class="fu">enum</span><span class="op">(</span><span class="va">`Fair`</span>,<span class="va">`Good`</span>,<span class="va">`Very Good`</span>,<span class="va">`Premium`</span>,<span class="va">`Ideal`</span>, .ordered<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">~</span> <span class="st">"the cut column"</span>,</span>
<span>  color <span class="op">=</span> <span class="fu">enum</span><span class="op">(</span><span class="va">`D`</span>,<span class="va">`E`</span>,<span class="va">`F`</span>,<span class="va">`G`</span>,<span class="va">`H`</span>,<span class="va">`I`</span>,<span class="va">`J`</span>, .ordered<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">~</span> <span class="st">"the color column"</span>,</span>
<span>  clarity <span class="op">=</span> <span class="fu">enum</span><span class="op">(</span><span class="va">`I1`</span>,<span class="va">`SI2`</span>,<span class="va">`SI1`</span>,<span class="va">`VS2`</span>,<span class="va">`VS1`</span>,<span class="va">`VVS2`</span>,<span class="va">`VVS1`</span>,<span class="va">`IF`</span>, .ordered<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">~</span> <span class="st">"the clarity column"</span>,</span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">i_diamonds_data</span><span class="op">)</span> <span class="op">~</span> <span class="st">"A nested data column must be specified as a list"</span>,</span>
<span>  .groups <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">i_diamonds_data</span> <span class="op">=</span> <span class="fu">interfacer</span><span class="fu">::</span><span class="fu"><a href="../reference/iface.html">iface</a></span><span class="op">(</span></span>
<span>  carat <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the carat column"</span>,</span>
<span>  depth <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the depth column"</span>,</span>
<span>  table <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the table column"</span>,</span>
<span>  price <span class="op">=</span> <span class="va">integer</span> <span class="op">~</span> <span class="st">"the price column"</span>,</span>
<span>  x <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the x column"</span>,</span>
<span>  y <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the y column"</span>,</span>
<span>  z <span class="op">=</span> <span class="va">numeric</span> <span class="op">~</span> <span class="st">"the z column"</span>,</span>
<span>  .groups <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nested_diamonds</span> <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html" class="external-link">diamonds</a></span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">cut</span>,<span class="op">-</span><span class="va">color</span>,<span class="op">-</span><span class="va">clarity</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">nested_diamonds</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="../reference/iconvert.html">iconvert</a></span><span class="op">(</span><span class="va">i_diamonds_cat</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 276</span></span>
<span><span class="co">#&gt; Columns: 4</span></span>
<span><span class="co">#&gt; $ cut     <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span> Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver…</span></span>
<span><span class="co">#&gt; $ color   <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span> E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, I, E, G,…</span></span>
<span><span class="co">#&gt; $ clarity <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span> SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, …</span></span>
<span><span class="co">#&gt; $ data    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> [&lt;tbl_df[469 x 7]&gt;], [&lt;tbl_df[614 x 7]&gt;], [&lt;tbl_df[89 x 7]&gt;],…</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   2.808   0.007   2.815</span></span></code></pre></div>
<p>In this example the price column is removes before nesting. Errors in
the validation of nested columns are bubbled up to the top level.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html" class="external-link">diamonds</a></span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">price</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">cut</span>,<span class="op">-</span><span class="va">color</span>,<span class="op">-</span><span class="va">clarity</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/iconvert.html">iconvert</a></span><span class="op">(</span><span class="va">i_diamonds_cat</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error : input column `data` in function parameter `&lt;unknown&gt;(&lt;unknown&gt; = ?)` cannot be coerced to a list(i_diamonds_data): nested dataframe problem - missing columns: price</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><code>interfacer</code> does work with nested dataframes but there is
a performance hit if there are nested columns with <code>iface</code>
specifications. Care must be taken if this capability is used to keep
data validation performant.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robert Challen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
